<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Video Annotator - Censor with Time Ranges</title>
    <link rel="stylesheet" href="./css/style.css">
    <link rel="stylesheet" href="./css/uploadVideo.css">
    <link rel="stylesheet" href="./css/deleteVideo.css">
    <link rel="stylesheet" href="./css/censor.css">
    <!-- Include the FFmpeg library -->
    <script src="https://cdn.jsdelivr.net/npm/@ffmpeg/ffmpeg@0.10.1/dist/ffmpeg.min.js"></script>

    <!-- Optionally load config for Google Drive (if you have config.json) -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="./js/fetchVideo.js"></script>


</head>

<body>

    <div id="title"></div>
    <div class="videoEditContainer">
        <h2 id="video-name" class="bigName"></h2>

        <div class="videoWrapper">
            <!-- The video -->
            <video id="videoPlayer" crossOrigin="anonymous">
                <source id="videoSource" type="video/mp4">
                Your browser does not support the video tag.
            </video>

            <!-- The canvas overlay on top -->
            <canvas id="overlayCanvas"></canvas>
        </div>

        <!-- Progress bar container -->
        <div class="progress-container" id="progress-container">
            <div class="progress-bar" id="progress-bar"></div>
            <span id="timestamp">00:00:000</span>
        </div>

        <!-- Controls row -->
        <div class="controls">
            <button id="previous-frame-button">&#10508</button>
            <button id="play-button">&#9654</button>
            <button id="screenshot-btn" class="download-frame-button">
                <img src="./assets/screenshot.png" width="40px">
            </button>
            <button id="pause-button">&#10073&#10073</button>
            <button id="next-frame-button">&#10509</button>

            <!-- Brush + brush size selection -->
            <button id="brushButton">üñåÔ∏è</button>
            <div class="playback-container">
                <label for="size-slider">Brush Size:</label>
                <input type="range" id="size-slider" min="5" max="100" value="20" step="1">
                <span id="size-value">20</span>
            </div>

            <div class="playback-container">
                <label for="colorPicker">Color:</label>
                <input type="color" id="colorPicker" value="#ff0000">
              </div>
            <!-- Save final censored video -->
            <button id="saveButton">üíæ</button>

            <!-- Speed control -->
            <div class="playback-container">
                <label for="speed-slider">Speed:</label>
                <input type="range" id="speed-slider" min="0.5" max="2" value="1" step="0.1">
                <span id="speed-value">1x</span>
            </div>
        </div>

        <!-- Time range selection and "Add Region" -->
        <div class="time-range-container">
            <button id="setStartButton">Set Start</button>
            <button id="setEndButton">Set End</button>
            <span>Current Start: <span id="startTimeDisplay">0.0</span>s</span>
            <span>Current End: <span id="endTimeDisplay">0.0</span>s</span>
            <button id="addRegionButton">Add Blur Region</button>
        </div>

        <a id="download">Download Censored Video</a>
    </div>

    <script>
        let CLIENT_ID;
        fetch('./config.json')
            .then(response => response.json())
            .then(config => {
                CLIENT_ID = config.CLIENT_ID;
            })
            .catch(error => console.error('Error loading config:', error));
        const params = new URLSearchParams(window.location.search);
        const token = localStorage.getItem('access_token');
        const id_db = params.get('id');
        let videoId = undefined;

        fetch(`videos/${id_db}.mp4`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Video not found');
                }
                return response.blob();
            })
            .then(blob => {
                const videoPlayer = document.getElementById('videoPlayer');
                const videoSource = document.getElementById('videoSource');
                videoSource.src = URL.createObjectURL(blob);
                videoPlayer.load();
                fetch(`./php/drive_id_by_id.php?id=${id_db}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.drive_id) {
                            document.getElementById('video-name').textContent = data.name
                        } else {
                            alert('No drive_id found for the given video id.');
                        }
                    })
                    .catch(error => {
                        alert(error);
                    });
            })
            .catch(error => {
                console.log("Not found locally ");
                fetch(`./php/drive_id_by_id.php?id=${id_db}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.drive_id) {
                            params.set('id', data.drive_id);
                            fetchVideo(data.drive_id, localStorage.getItem('access_token'), 'videoPlayer');
                            document.getElementById('video-name').textContent = data.name
                        } else {
                            alert('No drive_id found for the given video id.');
                        }
                    })
                    .catch(error => {
                        alert(error);
                        const videoPlayer = document.getElementById('videoPlayer');
                        const videoSource = document.getElementById('videoSource');
                        videoSource.src = '/videos/not_found.mp4';
                        videoPlayer.load();
                    });
            });
    </script>
    <div id="footer"></div>

    <script src="./js/censorPageScript.js"></script>

    <script src="./js/headerCreator.js"></script>

    <script src="./js/footerCreator.js"></script>
</body>

</html>