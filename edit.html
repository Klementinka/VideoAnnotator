<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Annotator - Edit</title>
    <link rel="stylesheet" href="./css/style.css">
    <link rel="stylesheet" href="./css/editPageStyle.css">
    <script src="https://accounts.google.com/gsi/client" async defer></script>
</head>

<body>

    <div id="title"></div>

    <script>
        const params = new URLSearchParams(window.location.search);
        const token = params.get('token');
        if (!token || token === 'null') {
            window.history.back();
        }
        console.log('Token from params:', token);

        if (token) {
            fetch('https://www.googleapis.com/oauth2/v3/tokeninfo?id_token=' + token)
                .then(response => response.json())
                .then(data => {
                    if (data.aud === '207542469934-k8oqld6o88ah3mqom7u8kc5j9hhd8nm6.apps.googleusercontent.com') {
                        initializeTokenClient();
                    } else {
                        console.error('Invalid token audience.');
                    }
                })
                .catch(error => console.error('Error verifying token:', error));
        } else {
            console.error('No token provided in URL.');
        }

        function fetchVideo() {
            const videoId = getQueryParam('id'); // Implement getQueryParam to extract 'id' from URL
            if (!videoId) {
                document.body.innerHTML += '<p>No video ID provided.</p>';
                return;
            }

            const videoUrl = `https://www.googleapis.com/drive/v3/files/${videoId}?alt=media`;

            fetch(videoUrl, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            })
                .then(response => {
                    if (response.ok) {
                        const videoPlayer = document.getElementById('videoPlayer');
                        videoPlayer.src = videoUrl;
                        videoPlayer.load();
                    } else {
                        document.body.innerHTML += `<p>Error fetching video: ${response.statusText}</p>`;
                    }
                })
                .catch(err => {
                    document.body.innerHTML += `<p>Error: ${err.message}</p>`;
                });
        }

    </script>

    <main>
        <h2 id="video-name" class="bigName"></h2>

        <video id="videoPlayer" width="640px" height="480px" controls crossOrigin="anonymous">
            <source id="videoSource" type="video/mp4">
            Your browser does not support the video tag.
        </video>

        <canvas id="canvas" style="display: none;"></canvas>

        <div class="progress-container">
            <progress class="progress-bar" id="progress-bar"></progress>
        </div>

        <div class="button-container">
            <button id="create-tag-button">Create Tag</button>
            <button id="download-button">Download First 5 Seconds</button>
        </div>

        <div id="timestamp-container"></div>
        <label for="timestamp">Current Timestamp (ms):</label>
        <span id="timestamp">0</span>
        </div>

        <button id="download-frame-button">Download Current Frame</button>

        <script>
            document.getElementById('download-frame-button').addEventListener('click', function () {
                const video = document.getElementById('videoPlayer');
                const canvas = document.createElement('canvas');
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                const context = canvas.getContext('2d');
                context.drawImage(video, 0, 0, canvas.width, canvas.height);
                canvas.toDataURL('image/png');
                const dataURL = canvas.toDataURL('image/png');
                const a = document.createElement('a');
                a.href = dataURL;
                a.download = 'frame-screenshot.png';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            });
        </script>

        <script>
            const timestampContainer = document.getElementById('timestamp');

            videoPlayer.addEventListener('timeupdate', function () {
                const minutes = Math.floor(videoPlayer.currentTime / 60);
                const seconds = Math.floor(videoPlayer.currentTime % 60);
                const milliseconds = Math.floor((videoPlayer.currentTime % 1) * 1000);
                const formattedTime = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}:${milliseconds.toString().padStart(3, '0')}`;
                timestampContainer.textContent = formattedTime;
            });
        </script>

        <button id="next-frame-button">Next Frame</button>

        <div class="slider-container"></div>
        <label for="speed-slider">Playback Speed:</label>
        <input type="range" id="speed-slider" min="0.5" max="2" value="1" step="0.1">
        <span id="speed-value">1x</span>
        </div>

        <script>
            const speedSlider = document.getElementById('speed-slider');
            const speedValue = document.getElementById('speed-value');
            const videoPlayer = document.getElementById('videoPlayer');

            speedSlider.addEventListener('input', function () {
                const speed = speedSlider.value;
                videoPlayer.playbackRate = speed;
                speedValue.textContent = speed + 'x';
            });
        </script>

        <div class="time-input-container">
            <label for="start-time">Start Time (mm:ss:ms):</label>
            <input type="text" id="start-time" placeholder="00:00:000">
            <label for="end-time">End Time (mm:ss:ms):</label>
            <input type="text" id="end-time" placeholder="00:00:000">
        </div>

        <div id="selected-video-container"></div>

        <button id="process">Download Selected Video</button>

        <a id="download" style="display: none;">Download New Video</a>

        <script>
            const video = document.getElementById('videoPlayer');
            const canvas = document.getElementById('canvas');
            const ctx = canvas.getContext('2d');
            const processButton = document.getElementById('process');
            const downloadLink = document.getElementById('download');
            const startTimeInput = document.getElementById('start-time');
            const endTimeInput = document.getElementById('end-time');

            processButton.addEventListener('click', async () => {

                let startTime = startTimeInput.value.split(':').map(parseFloat);
                startTime = startTime[0] * 60 + startTime[1] + startTime[2] / 1000;
                let endTime = endTimeInput.value.split(':').map(parseFloat);
                endTime = endTime[0] * 60 + endTime[1] + endTime[2] / 1000;

                console.log('start', startTime, 'end', endTime);

                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                console.log('canvas', canvas.width, canvas.height);

                const stream = canvas.captureStream(); // Capture canvas stream
                const mediaRecorder = new MediaRecorder(stream, { mimeType: 'video/webm' });
                const chunks = [];

                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) chunks.push(event.data);
                };

                mediaRecorder.onstop = () => {
                    console.log('stop', chunks.length);
                    const blob = new Blob(chunks, { type: 'video/webm' });
                    
                    const url = URL.createObjectURL(blob);

                    downloadLink.href = url;
                    downloadLink.download = `${getQueryParam('id')}-${startTime}-${endTime}.webm`;
                    downloadLink.style.display = 'block';
                    downloadLink.textContent = 'Download New Video';
                };

                mediaRecorder.start();

                const frameInterval = Math.floor(video.fps || 30);

                for (let time = Math.max(0, startTime); time < Math.min(endTime, video.duration); time += 1 / frameInterval) {
                    console.log('frame', time);
                    video.currentTime = time;
                    await new Promise(resolve => video.addEventListener('seeked', resolve, { once: true }));
                    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                }

                mediaRecorder.stop();
            });
        </script>

        <script>
            document.getElementById('select-frames-button').addEventListener('click', function () {
                const startFrame = parseInt(document.getElementById('start-frame').value);
                const endFrame = parseInt(document.getElementById('end-frame').value);
                const frameRate = 30; // Assuming the video has a frame rate of 30 fps

                if (isNaN(startFrame) || isNaN(endFrame) || startFrame < 0 || endFrame < 0 || startFrame >= endFrame) {
                    alert('Please enter valid start and end frames.');
                    return;
                }

                const startTime = startFrame / frameRate;
                const endTime = endFrame / frameRate;

                const selectedVideoContainer = document.getElementById('selected-video-container');
                selectedVideoContainer.innerHTML = ''; // Clear previous selection

                const videoTag = document.createElement('video');
                videoTag.width = 320;
                videoTag.height = 240;
                videoTag.controls = true;
                const sourceTag = document.createElement('source');
                sourceTag.src = document.getElementById('videoSource').src + `#t=${startTime},${endTime}`;
                sourceTag.type = 'video/mp4';
                videoTag.appendChild(sourceTag);


                selectedVideoContainer.appendChild(videoTag);
            });
        </script>

        <script>
            document.getElementById('next-frame-button').addEventListener('click', function () {
                const video = document.getElementById('videoPlayer');
                const frameRate = 30; // Assuming the video has a frame rate of 30 fps
                video.currentTime += 1 / frameRate;
            });
        </script>

        <script>
            document.getElementById('create-tag-button').addEventListener('click', function () {
                const video = document.getElementById('videoPlayer');
                const tagContainer = document.createElement('div');
                tagContainer.className = 'tag';
                const videoTag = document.createElement('video');
                videoTag.id = 'tagged-video';
                videoTag.width = 320;
                videoTag.height = 240;
                videoTag.controls = true;
                const sourceTag = document.createElement('source');
                sourceTag.src = document.getElementById('videoSource').src + '#t=0,5';
                sourceTag.type = 'video/mp4';
                videoTag.appendChild(sourceTag);
                tagContainer.appendChild(videoTag);
                document.querySelector('main').appendChild(tagContainer);
            });

            document.getElementById('download-button').addEventListener('click', function () {
                const video = document.getElementById('videoPlayer');
                const videoSource = document.getElementById('tagged-video').src;
                const a = document.createElement('a');
                a.href = videoSource + '#t=0,5';
                a.download = 'first-5-seconds.mp4';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            });
        </script>

    </main>

    <div id="output"></div>

    <div id="footer"></div>

    <script src="./js/editPageScript.js"></script>

    <script src="./js/headerCreator.js"></script>

    <script src="./js/footerCreator.js"></script>
</body>

</html>